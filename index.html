<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#FAF6F0">
<title>AeroPress Recipes & Timer — Bo's Third Brew</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { background: #FAF6F0; font-family: -apple-system, 'Segoe UI', Roboto, sans-serif; }
  input, textarea, select { font-family: inherit; outline: none; }
  button { font-family: inherit; outline: none; }
  ::-webkit-scrollbar { display: none; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

// ─── Theme: Morning Light ──────────────────────────────────
const C = {
  bg: "#FAF6F0",
  card: "#FFFFFF",
  accent: "#2878A8",
  terra: "#C45D3E",
  gold: "#D4960A",
  amber: "#E8A820",
  teal: "#3A9DB8",
  sage: "#5A9E58",
  text: "#2C2016",
  subtle: "#887868",
  cancel: "#B83830",
  border: "#E0D5C8",
  inputBg: "#F5EFE6",
  shadow: "0 2px 8px rgba(44,32,22,0.08)",
};

// ─── Grinder Database ──────────────────────────────────────
const GRINDERS = {
  none: { name: "Description only", short: "" },
  df64: { name: "DF64", short: "DF64" },
  comandante: { name: "Comandante C40", short: "C40" },
  jxpro: { name: "1Zpresso JX-Pro", short: "JX" },
  encore: { name: "Baratza Encore", short: "Encore" },
  timemore: { name: "Timemore C2/C3", short: "TM" },
};

const GRIND_MAP = {
  df64: { "Extra fine": "~10", "Very fine": "~15", "Very fine (espresso-like)": "~15", "Fine": "~22", "Fine drip": "~24", "Fine-medium": "~28", "Medium-fine": "~34", "Medium": "~40", "Medium-coarse": "~46", "Coarse": "~52", "Slightly finer than filter": "~32" },
  comandante: { "Extra fine": "~10", "Very fine": "~12", "Very fine (espresso-like)": "~12", "Fine": "~16", "Fine drip": "~18", "Fine-medium": "~20", "Medium-fine": "~24", "Medium": "~28", "Medium-coarse": "~32", "Coarse": "~36", "Slightly finer than filter": "~22" },
  jxpro: { "Extra fine": "~10", "Very fine": "~13", "Very fine (espresso-like)": "~13", "Fine": "~18", "Fine drip": "~20", "Fine-medium": "~22", "Medium-fine": "~27", "Medium": "~32", "Medium-coarse": "~36", "Coarse": "~40", "Slightly finer than filter": "~25" },
  encore: { "Extra fine": "~5", "Very fine": "~7", "Very fine (espresso-like)": "~7", "Fine": "~10", "Fine drip": "~12", "Fine-medium": "~14", "Medium-fine": "~18", "Medium": "~22", "Medium-coarse": "~26", "Coarse": "~30", "Slightly finer than filter": "~16" },
  timemore: { "Extra fine": "~6", "Very fine": "~8", "Very fine (espresso-like)": "~8", "Fine": "~10", "Fine drip": "~12", "Fine-medium": "~14", "Medium-fine": "~18", "Medium": "~22", "Medium-coarse": "~24", "Coarse": "~28", "Slightly finer than filter": "~16" },
};

const getGrindNum = (grinder, grindDesc) => {
  if (grinder === "none" || !GRIND_MAP[grinder]) return null;
  return GRIND_MAP[grinder][grindDesc] || null;
};

const GRIND_ORDER = ["Extra fine", "Very fine", "Very fine (espresso-like)", "Fine", "Fine drip", "Fine-medium", "Slightly finer than filter", "Medium-fine", "Medium", "Medium-coarse", "Coarse"];
const grindRank = (g) => { const i = GRIND_ORDER.indexOf(g); return i >= 0 ? i : 99; };
const getPlace = (name) => { if (name.includes("— 1st")) return 1; if (name.includes("— 2nd")) return 2; if (name.includes("— 3rd")) return 3; return 9; };

const cToF = (c) => Math.round(c * 9 / 5 + 32);
const fmt = (s) => `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, "0")}`;

// ─── API ──────────────────────────────────────────────────
const API = "https://bobrew.dev/api";

// ─── Recipe Data ───────────────────────────────────────────
const RECIPES = [
  { id: "classic-01", name: "Alan Adler Original", credit: "Alan Adler (AeroPress inventor)", category: "Classic", coffeeG: 15, waterG: 220, tempC: 80, grind: "Fine drip", method: "Standard", totalTime: 60, steps: [{ action: "pour", text: "Add coffee and pour water", waterTo: 220, waterAdd: 220, duration: 10 },{ action: "stir", text: "Stir gently", duration: 10 },{ action: "press", text: "Press slowly and steadily", duration: 30 }] },
  { id: "classic-02", name: "Hoffmann Ultimate", credit: "James Hoffmann", category: "Classic", coffeeG: 11, waterG: 200, tempC: 100, grind: "Medium-fine", method: "Standard", totalTime: 155, steps: [{ action: "pour", text: "Pour all water in one go", waterTo: 200, waterAdd: 200, duration: 10 },{ action: "wait", text: "Wait — don't touch it", duration: 120 },{ action: "stir", text: "Swirl gently 3 times", duration: 5 },{ action: "press", text: "Press very gently, stop at hiss", duration: 20 }] },
  { id: "classic-03", name: "Tim Wendelboe", credit: "Tim Wendelboe", category: "Classic", coffeeG: 14, waterG: 200, tempC: 100, grind: "Medium-fine", method: "Inverted", totalTime: 75, steps: [{ action: "pour", text: "Pour water quickly", waterTo: 200, waterAdd: 200, duration: 10 },{ action: "stir", text: "Stir back and forth 3 times", duration: 5 },{ action: "wait", text: "Attach cap with rinsed filter, wait", duration: 30 },{ action: "press", text: "Flip and press slowly", duration: 30 }] },
  { id: "classic-04", name: "Coffee with April", credit: "April Brews (Coffee with April)", category: "Classic", coffeeG: 13, waterG: 200, tempC: 88, grind: "Medium-coarse", method: "Standard", totalTime: 120, steps: [{ action: "pour", text: "Pour water quickly, stir a little", waterTo: 50, waterAdd: 50, duration: 15 },{ action: "wait", text: "Put piston on to stop dripping, wait", duration: 15 },{ action: "pour", text: "Remove piston, pour remaining water", waterTo: 200, waterAdd: 150, duration: 30 },{ action: "wait", text: "Put piston back on, wait", duration: 30 },{ action: "press", text: "Press down slowly, stop at hiss", duration: 30 }] },
  { id: "classic-05", name: "The Bypass Brew", credit: "Community recipe", category: "Classic", coffeeG: 18, waterG: 250, tempC: 92, grind: "Medium", method: "Standard", totalTime: 120, steps: [{ action: "pour", text: "Pour concentrate water", waterTo: 150, waterAdd: 150, duration: 10 },{ action: "stir", text: "Stir vigorously 5 times", duration: 10 },{ action: "wait", text: "Steep with cap on", duration: 60 },{ action: "press", text: "Press into cup", duration: 20 },{ action: "pour", text: "Add bypass water to cup", waterTo: 250, waterAdd: 100, duration: 20 }] },
  { id: "classic-06", name: "Jonathan Gagné Long", credit: "Jonathan Gagné", category: "Classic", coffeeG: 18, waterG: 260, tempC: 100, grind: "Medium-coarse", method: "Standard", totalTime: 600, steps: [{ action: "pour", text: "Fill AeroPress with water", waterTo: 260, waterAdd: 260, duration: 15 },{ action: "stir", text: "Stir back and forth (not circular)", duration: 15 },{ action: "wait", text: "Place plunger, remove from scale, wait", duration: 270 },{ action: "stir", text: "Give a thorough swirl", duration: 10 },{ action: "wait", text: "Continue waiting", duration: 230 },{ action: "press", text: "Press very gently for about 60 seconds", duration: 60 }] },
  { id: "classic-07", name: "Blue Bottle Inspired", credit: "Blue Bottle Coffee", category: "Classic", coffeeG: 15, waterG: 210, tempC: 96, grind: "Medium-fine", method: "Standard", totalTime: 105, steps: [{ action: "pour", text: "Bloom — pour slowly over grounds", waterTo: 40, waterAdd: 40, duration: 10 },{ action: "wait", text: "Let bloom", duration: 15 },{ action: "pour", text: "Pour remaining water in slow circles", waterTo: 210, waterAdd: 170, duration: 15 },{ action: "stir", text: "Stir once gently", duration: 5 },{ action: "wait", text: "Steep", duration: 30 },{ action: "press", text: "Press slow and steady", duration: 30 }] },
  { id: "classic-08", name: "The Gentle Morning", credit: "Community recipe", category: "Classic", coffeeG: 12, waterG: 200, tempC: 85, grind: "Medium", method: "Standard", totalTime: 150, steps: [{ action: "pour", text: "Pour water gently", waterTo: 200, waterAdd: 200, duration: 15 },{ action: "wait", text: "No stirring — let it steep quietly", duration: 105 },{ action: "press", text: "Press very slowly", duration: 30 }] },
  { id: "classic-09", name: "The Full Immersion", credit: "Community recipe", category: "Classic", coffeeG: 16, waterG: 240, tempC: 93, grind: "Medium-coarse", method: "Inverted", totalTime: 180, steps: [{ action: "pour", text: "Pour half the water", waterTo: 120, waterAdd: 120, duration: 10 },{ action: "stir", text: "Stir to saturate all grounds", duration: 10 },{ action: "pour", text: "Pour remaining water", waterTo: 240, waterAdd: 120, duration: 10 },{ action: "wait", text: "Steep — full immersion", duration: 120 },{ action: "press", text: "Flip carefully and press", duration: 30 }] },
  { id: "classic-10", name: "The Gravity Drip", credit: "Community recipe", category: "Classic", coffeeG: 15, waterG: 230, tempC: 95, grind: "Medium", method: "Standard", totalTime: 240, steps: [{ action: "pour", text: "Pour water over grounds slowly", waterTo: 230, waterAdd: 230, duration: 20 },{ action: "stir", text: "Gentle single stir", duration: 5 },{ action: "wait", text: "Let gravity pull water through — no press", duration: 215 }] },
  { id: "classic-11", name: "Stumptown Style", credit: "Stumptown Coffee", category: "Classic", coffeeG: 17, waterG: 220, tempC: 96, grind: "Medium-fine", method: "Inverted", totalTime: 105, steps: [{ action: "pour", text: "Bloom with small amount of water", waterTo: 40, waterAdd: 40, duration: 10 },{ action: "wait", text: "Let bloom", duration: 15 },{ action: "pour", text: "Fill to top", waterTo: 220, waterAdd: 180, duration: 10 },{ action: "stir", text: "Stir 10 times", duration: 10 },{ action: "wait", text: "Cap and steep", duration: 30 },{ action: "press", text: "Flip and press", duration: 30 }] },
  { id: "classic-12", name: "The Two-Minute Cup", credit: "Community recipe", category: "Classic", coffeeG: 14, waterG: 200, tempC: 90, grind: "Medium", method: "Standard", totalTime: 120, steps: [{ action: "pour", text: "Pour all water", waterTo: 200, waterAdd: 200, duration: 10 },{ action: "stir", text: "Stir 5 times", duration: 10 },{ action: "wait", text: "Steep with plunger in", duration: 70 },{ action: "press", text: "Press gently", duration: 30 }] },
  { id: "classic-13", name: "Low Agitation Brew", credit: "AeroPrecipe community", category: "Classic", coffeeG: 16, waterG: 235, tempC: 88, grind: "Medium-coarse", method: "Standard", totalTime: 150, steps: [{ action: "pour", text: "Pour water slowly — no splash", waterTo: 235, waterAdd: 235, duration: 20 },{ action: "wait", text: "No stirring — just wait", duration: 100 },{ action: "press", text: "Press extremely slowly", duration: 30 }] },
  { id: "classic-14", name: "The Bold Dark", credit: "Community recipe", category: "Classic", coffeeG: 18, waterG: 200, tempC: 85, grind: "Fine", method: "Inverted", totalTime: 120, steps: [{ action: "pour", text: "Pour water", waterTo: 200, waterAdd: 200, duration: 10 },{ action: "stir", text: "Stir vigorously 15 times", duration: 15 },{ action: "wait", text: "Steep", duration: 60 },{ action: "stir", text: "Stir 5 more times", duration: 5 },{ action: "press", text: "Flip and press firmly", duration: 30 }] },
  { id: "classic-15", name: "Sweet & Clean", credit: "Community recipe", category: "Classic", coffeeG: 13, waterG: 210, tempC: 92, grind: "Medium-fine", method: "Standard", totalTime: 135, steps: [{ action: "pour", text: "Bloom pour", waterTo: 30, waterAdd: 30, duration: 10 },{ action: "wait", text: "Bloom", duration: 20 },{ action: "pour", text: "Pour remaining water gently", waterTo: 210, waterAdd: 180, duration: 15 },{ action: "stir", text: "Swirl once", duration: 5 },{ action: "wait", text: "Steep", duration: 55 },{ action: "press", text: "Press slow, stop before hiss", duration: 30 }] },
  { id: "champ-01", name: "Stanica 2024 — 1st", credit: "George Stanica, Romania (WAC 2024)", category: "Championship", year: 2024, coffeeG: 18, waterG: 186, tempC: 96, grind: "Medium", method: "Inverted", totalTime: 135, steps: [{ action: "pour", text: "Pour hot water", waterTo: 150, waterAdd: 150, duration: 12 },{ action: "stir", text: "Stir firmly 20 times", duration: 13 },{ action: "wait", text: "Attach cap, press out air, wait", duration: 80 },{ action: "press", text: "Flip and press gently", duration: 20 },{ action: "pour", text: "Add room temp water to cup", waterTo: 186, waterAdd: 36, duration: 10 }] },
  { id: "champ-02", name: "Nugraha 2024 — 2nd", credit: "Sophan Nugraha, Indonesia (WAC 2024)", category: "Championship", year: 2024, coffeeG: 18, waterG: 200, tempC: 93, grind: "Medium-fine", method: "Inverted", totalTime: 150, steps: [{ action: "pour", text: "Pour water", waterTo: 200, waterAdd: 200, duration: 15 },{ action: "stir", text: "Stir gently 10 times", duration: 15 },{ action: "wait", text: "Steep", duration: 90 },{ action: "press", text: "Flip and press slowly", duration: 30 }] },
  { id: "champ-03", name: "Emi Fukahori 2018 — 1st", credit: "Emi Fukahori, Switzerland (WAC 2018)", category: "Championship", year: 2018, coffeeG: 16.5, waterG: 245, tempC: 84, grind: "Coarse", method: "Standard", totalTime: 75, steps: [{ action: "pour", text: "Pour all water quickly", waterTo: 245, waterAdd: 245, duration: 10 },{ action: "stir", text: "Stir back and forth 5 times", duration: 8 },{ action: "wait", text: "Steep", duration: 27 },{ action: "press", text: "Press gently for 30 seconds", duration: 30 }] },
  { id: "champ-04", name: "Kucharczyk 2019 — 1st", credit: "Filip Kucharczyk, Poland (WAC 2019)", category: "Championship", year: 2019, coffeeG: 16.5, waterG: 230, tempC: 84, grind: "Medium", method: "Standard", totalTime: 90, steps: [{ action: "pour", text: "Pour water", waterTo: 230, waterAdd: 230, duration: 15 },{ action: "stir", text: "Stir 3 times", duration: 5 },{ action: "wait", text: "Insert plunger, steep", duration: 40 },{ action: "press", text: "Press gently", duration: 30 }] },
  { id: "champ-05", name: "Miczka 2017 — 1st", credit: "Paulina Miczka, Poland (WAC 2017)", category: "Championship", year: 2017, coffeeG: 20, waterG: 220, tempC: 82, grind: "Fine-medium", method: "Standard", totalTime: 75, steps: [{ action: "pour", text: "Pour water quickly", waterTo: 220, waterAdd: 220, duration: 10 },{ action: "stir", text: "Stir 4 times clockwise, 4 counter", duration: 10 },{ action: "wait", text: "Insert plunger, wait", duration: 25 },{ action: "press", text: "Press steadily", duration: 30 }] },
  { id: "champ-06", name: "Zahradnik 2015 — 1st", credit: "Lukas Zahradnik, Czech Republic (WAC 2015)", category: "Championship", year: 2015, coffeeG: 20, waterG: 230, tempC: 78, grind: "Fine", method: "Inverted", totalTime: 105, steps: [{ action: "pour", text: "Pour water", waterTo: 230, waterAdd: 230, duration: 10 },{ action: "stir", text: "Stir aggressively", duration: 15 },{ action: "wait", text: "Cap and steep", duration: 50 },{ action: "press", text: "Flip and press slowly", duration: 30 }] },
  { id: "champ-07", name: "Sasaki 2014 — 1st", credit: "Shuichi Sasaki, Japan (WAC 2014)", category: "Championship", year: 2014, coffeeG: 16.5, waterG: 250, tempC: 78, grind: "Fine-medium", method: "Inverted", totalTime: 100, steps: [{ action: "pour", text: "Pour 40g to bloom", waterTo: 40, waterAdd: 40, duration: 10 },{ action: "stir", text: "Stir 5 times", duration: 5 },{ action: "pour", text: "Pour remaining water", waterTo: 250, waterAdd: 210, duration: 15 },{ action: "wait", text: "Wait", duration: 40 },{ action: "press", text: "Flip and press slowly", duration: 30 }] },
  { id: "champ-08", name: "Verellen 2013 — 1st", credit: "Jeff Verellen, Belgium (WAC 2013)", category: "Championship", year: 2013, coffeeG: 17, waterG: 270, tempC: 80, grind: "Coarse", method: "Standard", totalTime: 110, steps: [{ action: "pour", text: "Wet grounds with small pour", waterTo: 40, waterAdd: 40, duration: 10 },{ action: "pour", text: "Slowly pour remaining", waterTo: 270, waterAdd: 230, duration: 30 },{ action: "wait", text: "Let steep and drip", duration: 50 },{ action: "press", text: "Gently press — stop before air", duration: 20 }] },
  { id: "champ-09", name: "de Buysere 2012 — 1st", credit: "Charlene de Buysere, Belgium (WAC 2012)", category: "Championship", year: 2012, coffeeG: 17, waterG: 270, tempC: 80, grind: "Coarse", method: "Standard", totalTime: 90, steps: [{ action: "pour", text: "Pour water gently", waterTo: 270, waterAdd: 270, duration: 15 },{ action: "wait", text: "No stirring — steep", duration: 50 },{ action: "press", text: "Slow press, stop at hiss", duration: 20 }] },
  { id: "champ-10", name: "Verellen 2011 — 1st", credit: "Jeff Verellen, Belgium (WAC 2011)", category: "Championship", year: 2011, coffeeG: 17, waterG: 270, tempC: 80, grind: "Coarse", method: "Standard", totalTime: 90, steps: [{ action: "pour", text: "Rinse filter, add coffee, pour water", waterTo: 270, waterAdd: 270, duration: 15 },{ action: "wait", text: "No stirring — let it steep", duration: 50 },{ action: "press", text: "Slow press, stop before air", duration: 20 }] },
  { id: "champ-11", name: "Garay 2023 — 1st", credit: "Carolina Garay, Chile (WAC 2023)", category: "Championship", year: 2023, coffeeG: 16, waterG: 200, tempC: 90, grind: "Medium-fine", method: "Standard", totalTime: 120, steps: [{ action: "pour", text: "Pour water in circles", waterTo: 200, waterAdd: 200, duration: 15 },{ action: "stir", text: "Stir gently back and forth", duration: 10 },{ action: "wait", text: "Cap and steep", duration: 65 },{ action: "press", text: "Press gently", duration: 30 }] },
  { id: "champ-12", name: "Hasager 2010 — 2nd", credit: "Jeppe Hasager, Denmark (WAC 2010)", category: "Championship", year: 2010, coffeeG: 20, waterG: 260, tempC: 80, grind: "Slightly finer than filter", method: "Inverted", totalTime: 80, steps: [{ action: "pour", text: "Pour water nearly to top", waterTo: 260, waterAdd: 260, duration: 10 },{ action: "stir", text: "Stir 10-12 seconds", duration: 12 },{ action: "wait", text: "Attach rinsed filter, brief rest", duration: 28 },{ action: "press", text: "Flip and press slowly, stop before air", duration: 30 }] },
  { id: "espresso-01", name: "Hoffmann Espresso", credit: "James Hoffmann", category: "Espresso-style", coffeeG: 18, waterG: 56, tempC: 100, grind: "Very fine (espresso-like)", method: "Standard", totalTime: 85, steps: [{ action: "pour", text: "Pour all water onto grounds", waterTo: 56, waterAdd: 56, duration: 10 },{ action: "stir", text: "Stir vigorously to remove clumps", duration: 15 },{ action: "wait", text: "Wait for slurry to cool slightly", duration: 30 },{ action: "press", text: "Press firmly and evenly", duration: 30 }] },
  { id: "espresso-02", name: "Concentrated Press", credit: "Community recipe", category: "Espresso-style", coffeeG: 20, waterG: 60, tempC: 96, grind: "Very fine", method: "Inverted", totalTime: 90, steps: [{ action: "pour", text: "Pour water, ensuring all grounds wet", waterTo: 60, waterAdd: 60, duration: 10 },{ action: "stir", text: "Stir firmly 15 times", duration: 15 },{ action: "wait", text: "Steep", duration: 35 },{ action: "press", text: "Flip and press with firm pressure", duration: 30 }] },
  { id: "espresso-03", name: "The Faux-Spresso", credit: "AeroPrecipe community", category: "Espresso-style", coffeeG: 22, waterG: 70, tempC: 93, grind: "Extra fine", method: "Inverted", totalTime: 120, steps: [{ action: "pour", text: "Add water slowly", waterTo: 70, waterAdd: 70, duration: 10 },{ action: "stir", text: "Stir aggressively to form slurry", duration: 15 },{ action: "wait", text: "Steep under pressure", duration: 60 },{ action: "press", text: "Flip and press hard — expect resistance", duration: 35 }] },
  // ─── NEW: Championship 2025 ───
  { id: "champ-13", name: "Pop 2025 — 1st", credit: "Némo Pop, Australia (WAC 2025)", category: "Championship", year: 2025, coffeeG: 18, waterG: 170, tempC: 84, grind: "Medium-coarse", method: "Standard", totalTime: 70, steps: [{ action: "pour", text: "Pour 70g bypass water into carafe first", waterTo: 70, waterAdd: 70, duration: 5 },{ action: "pour", text: "Pour 100g brew water over grounds", waterTo: 170, waterAdd: 100, duration: 10 },{ action: "wait", text: "Wait — let bloom", duration: 15 },{ action: "stir", text: "Stir NSNS-WEWE pattern", duration: 10 },{ action: "press", text: "Press gently for 20 seconds", duration: 20 },{ action: "wait", text: "Serve — coffee mixes with bypass", duration: 10 }] },
  { id: "champ-14", name: "Ahrend 2025 — 2nd", credit: "Jan Ahrend, Switzerland (WAC 2025)", category: "Championship", year: 2025, coffeeG: 18, waterG: 152, tempC: 88, grind: "Medium-fine", method: "Inverted", totalTime: 120, steps: [{ action: "pour", text: "Pour 100g water in circular motion", waterTo: 100, waterAdd: 100, duration: 10 },{ action: "stir", text: "Stir 5 times NSWE pattern", duration: 10 },{ action: "wait", text: "Attach cap, push out air", duration: 10 },{ action: "wait", text: "Steep until 1:30", duration: 40 },{ action: "press", text: "Flip, swirl, press slowly to 66g output", duration: 30 },{ action: "pour", text: "Dilute to 152g total", waterTo: 152, waterAdd: 52, duration: 20 }] },
  { id: "champ-15", name: "Vyas 2025 — 3rd", credit: "Dharun Vyas, India (WAC 2025)", category: "Championship", year: 2025, coffeeG: 16, waterG: 220, tempC: 88, grind: "Coarse", method: "Inverted", totalTime: 180, steps: [{ action: "pour", text: "Pour 65ml water in spirals", waterTo: 65, waterAdd: 65, duration: 10 },{ action: "wait", text: "Wait 20 seconds", duration: 20 },{ action: "pour", text: "Pour remaining water with heavy center flow", waterTo: 208, waterAdd: 143, duration: 10 },{ action: "wait", text: "Wait, then attach cap and squeeze out air", duration: 20 },{ action: "wait", text: "Flip, swirl aggressively 4-5 times, settle 10s", duration: 20 },{ action: "press", text: "Press steadily for 60 seconds", duration: 60 },{ action: "pour", text: "Add 12ml room temp water to finish", waterTo: 220, waterAdd: 12, duration: 10 },{ action: "wait", text: "Swirl carafe to cool, serve", duration: 30 }] },
  // ─── NEW: Championship 2024 3rd ───
  { id: "champ-16", name: "Jamika 2024 — 3rd", credit: "Mahmoud Jamika, Egypt (WAC 2024)", category: "Championship", year: 2024, coffeeG: 18, waterG: 180, tempC: 80, grind: "Coarse", method: "Inverted", totalTime: 120, steps: [{ action: "pour", text: "Add 50ml water at 80°C", waterTo: 50, waterAdd: 50, duration: 8 },{ action: "stir", text: "Stir gently in circles 5 times", duration: 10 },{ action: "wait", text: "Bloom for 1 minute", duration: 42 },{ action: "pour", text: "Add 100ml water at 75°C", waterTo: 150, waterAdd: 100, duration: 10 },{ action: "wait", text: "Attach cap, squeeze air, stir 20 times", duration: 10 },{ action: "press", text: "Flip and press for 30 seconds", duration: 30 },{ action: "pour", text: "Add 30ml room temp water", waterTo: 180, waterAdd: 30, duration: 10 }] },
  // ─── NEW: Championship 2023 ───
  { id: "champ-17", name: "Wipvasutt 2023 — 1st", credit: "Tay Wipvasutt, Thailand (WAC 2023)", category: "Championship", year: 2023, coffeeG: 18, waterG: 155, tempC: 89, grind: "Medium-coarse", method: "Inverted", totalTime: 125, steps: [{ action: "pour", text: "Add 16g coffee, pour 100g water", waterTo: 100, waterAdd: 100, duration: 10 },{ action: "wait", text: "Wait to 0:30", duration: 20 },{ action: "stir", text: "Stir with chopstick 5 seconds", duration: 5 },{ action: "pour", text: "Add 2g extra coffee at 0:45", waterTo: 100, waterAdd: 0, duration: 5 },{ action: "stir", text: "Stir again at 0:55", duration: 5 },{ action: "wait", text: "Push plunger to remove air, close cap", duration: 20 },{ action: "press", text: "Flip and press at 1:35 for 30 seconds", duration: 30 },{ action: "pour", text: "Bypass with room temp + hot water to 155g", waterTo: 155, waterAdd: 55, duration: 30 }] },
  { id: "champ-18", name: "Bülow 2023 — 2nd", credit: "Carlo Graf Bülow, Germany (WAC 2023)", category: "Championship", year: 2023, coffeeG: 18, waterG: 150, tempC: 100, grind: "Medium-coarse", method: "Inverted", totalTime: 110, steps: [{ action: "pour", text: "Add 50g water for blooming", waterTo: 50, waterAdd: 50, duration: 8 },{ action: "stir", text: "Stir 32 times very fast", duration: 7 },{ action: "pour", text: "Add water to 160g, rinse filters", waterTo: 160, waterAdd: 110, duration: 15 },{ action: "wait", text: "Lock filter cap, wait until 1:25", duration: 30 },{ action: "press", text: "Flip and push slowly until 1:50", duration: 25 },{ action: "pour", text: "Dilute to 150g with room temp water", waterTo: 150, waterAdd: 15, duration: 10 },{ action: "stir", text: "Pour back and forth between servers 10x", duration: 15 }] },
  { id: "champ-19", name: "Zhang L. 2023 — 3rd", credit: "Leon Zhang, China (WAC 2023)", category: "Championship", year: 2023, coffeeG: 18, waterG: 235, tempC: 93, grind: "Medium", method: "Standard", totalTime: 100, steps: [{ action: "pour", text: "Add 100g water at 93°C, stir 15 rounds", waterTo: 100, waterAdd: 100, duration: 15 },{ action: "wait", text: "Place plunger, create vacuum, soak 45s", duration: 45 },{ action: "press", text: "Press at constant speed for 5 seconds", duration: 5 },{ action: "pour", text: "Add 135g water at 75°C, stir 5 turns", waterTo: 235, waterAdd: 135, duration: 10 },{ action: "wait", text: "Place plunger, vacuum, soak", duration: 15 },{ action: "press", text: "Press down clean at constant speed", duration: 10 }] },
  // ─── NEW: Championship 2022 ───
  { id: "champ-20", name: "Little 2022 — 1st", credit: "Jibbi Little, Australia (WAC 2022)", category: "Championship", year: 2022, coffeeG: 18, waterG: 150, tempC: 90, grind: "Medium", method: "Inverted", totalTime: 130, steps: [{ action: "pour", text: "Pour 94ml water", waterTo: 94, waterAdd: 94, duration: 10 },{ action: "stir", text: "Stir 35 times gently", duration: 20 },{ action: "wait", text: "Wait until 1:20, then cap and press air out", duration: 30 },{ action: "press", text: "Flip at 1:30, press for 30 seconds", duration: 30 },{ action: "pour", text: "Bypass with 90°C water to 150g total", waterTo: 150, waterAdd: 56, duration: 15 },{ action: "wait", text: "Serve at target TDS 1.3–1.35", duration: 25 }] },
  { id: "champ-21", name: "Derutter 2022 — 2nd", credit: "Simon Derutter, Belgium (WAC 2022)", category: "Championship", year: 2022, coffeeG: 18, waterG: 156, tempC: 85, grind: "Medium-fine", method: "Standard", totalTime: 105, steps: [{ action: "pour", text: "Pour 140ml water", waterTo: 140, waterAdd: 140, duration: 10 },{ action: "stir", text: "Stir three times", duration: 5 },{ action: "wait", text: "Place plunger, pull back for vacuum, brew to 1:15", duration: 60 },{ action: "press", text: "Press for 30 seconds until hiss", duration: 30 }] },
  { id: "champ-22", name: "Ho 2022 — 3rd", credit: "Jennifer Rui Ping Ho, Singapore (WAC 2022)", category: "Championship", year: 2022, coffeeG: 18, waterG: 200, tempC: 84, grind: "Medium-coarse", method: "Inverted", totalTime: 120, steps: [{ action: "pour", text: "Pour 100ml water", waterTo: 100, waterAdd: 100, duration: 10 },{ action: "stir", text: "Stir gently, bloom 30 seconds", duration: 30 },{ action: "pour", text: "Add 100ml water, stir gently", waterTo: 200, waterAdd: 100, duration: 10 },{ action: "wait", text: "Wait until 1:30", duration: 10 },{ action: "press", text: "Flip and press for 30 seconds", duration: 30 },{ action: "wait", text: "Aerate and serve", duration: 30 }] },
  // ─── NEW: Championship 2021 ───
  { id: "champ-23", name: "Merikanto 2021 — 1st", credit: "Tuomas Merikanto, Finland (WAC 2021)", category: "Championship", year: 2021, coffeeG: 18, waterG: 200, tempC: 80, grind: "Medium", method: "Inverted", totalTime: 120, steps: [{ action: "pour", text: "Pour 100ml water", waterTo: 100, waterAdd: 100, duration: 10 },{ action: "stir", text: "Stir gently, bloom 30 seconds", duration: 30 },{ action: "pour", text: "Add 100ml water, stir gently", waterTo: 200, waterAdd: 100, duration: 10 },{ action: "wait", text: "Wait until 1:30", duration: 10 },{ action: "press", text: "Flip and press for 30 seconds", duration: 30 },{ action: "wait", text: "Aerate and serve", duration: 30 }] },
  { id: "champ-24", name: "Mallee 2021 — 2nd", credit: "Maru Mallee, Netherlands (WAC 2021)", category: "Championship", year: 2021, coffeeG: 18, waterG: 186, tempC: 93, grind: "Medium-fine", method: "Inverted", totalTime: 135, steps: [{ action: "pour", text: "Pour 150g water", waterTo: 150, waterAdd: 150, duration: 12 },{ action: "stir", text: "Stir firmly 20 times", duration: 13 },{ action: "wait", text: "Screw on cap, press out air", duration: 5 },{ action: "wait", text: "Steep until 1:50", duration: 60 },{ action: "press", text: "Flip, swirl 3x, tap 2x, press gently to 2:15", duration: 25 },{ action: "pour", text: "Add 36g room temp water", waterTo: 186, waterAdd: 36, duration: 10 },{ action: "stir", text: "Swirl to cool for 1 minute", duration: 10 }] },
  { id: "champ-25", name: "Smith 2021 — 3rd", credit: "Brandon Smith, South Africa (WAC 2021)", category: "Championship", year: 2021, coffeeG: 18, waterG: 220, tempC: 88, grind: "Medium-fine", method: "Inverted", totalTime: 135, steps: [{ action: "pour", text: "Pour 140g water within 10 seconds", waterTo: 140, waterAdd: 140, duration: 10 },{ action: "stir", text: "Stir back to front gently 5 times", duration: 10 },{ action: "wait", text: "Brew, prepare filter, cap and press air out", duration: 40 },{ action: "wait", text: "Continue steeping", duration: 30 },{ action: "press", text: "Flip and press for 30 seconds", duration: 30 },{ action: "pour", text: "Add water to reach 220g", waterTo: 220, waterAdd: 80, duration: 15 }] },
  // ─── NEW: Championship 2018 ───
  { id: "champ-26", name: "Garay 2018 — 1st", credit: "Carolina Ibarra Garay, USA (WAC 2018)", category: "Championship", year: 2018, coffeeG: 35, waterG: 300, tempC: 85, grind: "Medium-coarse", method: "Inverted", totalTime: 120, steps: [{ action: "pour", text: "Pour 100g water over 30 seconds", waterTo: 100, waterAdd: 100, duration: 30 },{ action: "stir", text: "Stir vigorously with chopsticks 30 seconds", duration: 30 },{ action: "press", text: "Cap, flip, press into server for 30 sec", duration: 30 },{ action: "pour", text: "Add 60g hot + 40g room temp water", waterTo: 300, waterAdd: 200, duration: 30 }] },
  { id: "champ-27", name: "Pinchukov 2018 — 3rd", credit: "Evgeni Pinchukov, Belarus (WAC 2018)", category: "Championship", year: 2018, coffeeG: 15, waterG: 230, tempC: 80, grind: "Coarse", method: "Standard", totalTime: 95, steps: [{ action: "pour", text: "Add coffee and 50g water, let bloom", waterTo: 50, waterAdd: 50, duration: 10 },{ action: "stir", text: "Stir briefly", duration: 5 },{ action: "wait", text: "Wait 30 seconds", duration: 15 },{ action: "pour", text: "Add 180g water", waterTo: 230, waterAdd: 180, duration: 10 },{ action: "wait", text: "Wait until 1:05, then stir", duration: 25 },{ action: "press", text: "Press — stop when grounds visible above water", duration: 30 }] },
  // ─── NEW: Championship 2017 2nd/3rd ───
  { id: "champ-28", name: "Narisawa 2017 — 2nd", credit: "Yusuke Narisawa, Japan (WAC 2017)", category: "Championship", year: 2017, coffeeG: 35, waterG: 290, tempC: 84, grind: "Coarse", method: "Inverted", totalTime: 105, steps: [{ action: "pour", text: "Pour 150g water in 15 seconds", waterTo: 150, waterAdd: 150, duration: 15 },{ action: "stir", text: "Stir continuously for 20 seconds", duration: 20 },{ action: "wait", text: "Cap and wait", duration: 10 },{ action: "press", text: "Flip, swirl, press for 45 seconds — stop at hiss", duration: 45 },{ action: "pour", text: "Add 160–200g hot water to taste", waterTo: 290, waterAdd: 140, duration: 15 }] },
  { id: "champ-29", name: "Park 2017 — 3rd", credit: "Jeongsu Park, South Korea (WAC 2017)", category: "Championship", year: 2017, coffeeG: 35, waterG: 290, tempC: 84, grind: "Coarse", method: "Inverted", totalTime: 105, steps: [{ action: "pour", text: "Pour 150g water", waterTo: 150, waterAdd: 150, duration: 15 },{ action: "stir", text: "Stir vigorously", duration: 15 },{ action: "wait", text: "Wait until 1:00", duration: 15 },{ action: "press", text: "Flip and press for 35 seconds", duration: 35 },{ action: "pour", text: "Bypass with hot water to taste", waterTo: 290, waterAdd: 140, duration: 15 },{ action: "wait", text: "Serve", duration: 10 }] },
  // ─── NEW: Championship 2016 2nd/3rd ───
  { id: "champ-30", name: "Dittmar 2016 — 2nd", credit: "Jérôme Dittmar, France (WAC 2016)", category: "Championship", year: 2016, coffeeG: 27, waterG: 230, tempC: 82, grind: "Medium-coarse", method: "Inverted", totalTime: 130, steps: [{ action: "pour", text: "Pour 40g water for bloom", waterTo: 40, waterAdd: 40, duration: 10 },{ action: "wait", text: "Let steep 20 seconds", duration: 20 },{ action: "pour", text: "Pour water to 230g over 40 seconds", waterTo: 230, waterAdd: 190, duration: 40 },{ action: "press", text: "Flip and press for 40 seconds", duration: 40 },{ action: "wait", text: "Serve", duration: 20 }] },
  { id: "champ-31", name: "Rocco 2016 — 3rd", credit: "Hugo Sousa Rocco, Brazil (WAC 2016)", category: "Championship", year: 2016, coffeeG: 27, waterG: 200, tempC: 82, grind: "Medium-coarse", method: "Standard", totalTime: 270, steps: [{ action: "pour", text: "Add 60g water", waterTo: 60, waterAdd: 60, duration: 10 },{ action: "stir", text: "Stir for 12 seconds", duration: 12 },{ action: "wait", text: "Wait 1 minute", duration: 48 },{ action: "pour", text: "Add 110g water", waterTo: 170, waterAdd: 110, duration: 10 },{ action: "wait", text: "Wait 2.5 minutes", duration: 150 },{ action: "press", text: "Press for 30 seconds", duration: 30 },{ action: "pour", text: "Top up with water to 200g", waterTo: 200, waterAdd: 30, duration: 10 }] },
  // ─── NEW: Championship 2016 1st (corrected), 2015 2nd/3rd ───
  { id: "champ-32", name: "Kucharczyk 2016 — 1st", credit: "Filip Kucharczyk, Poland (WAC 2016)", category: "Championship", year: 2016, coffeeG: 35, waterG: 270, tempC: 81, grind: "Coarse", method: "Inverted", totalTime: 120, steps: [{ action: "pour", text: "Pour 150g water over 15 seconds", waterTo: 150, waterAdd: 150, duration: 15 },{ action: "stir", text: "Stir until 30 seconds on timer", duration: 15 },{ action: "wait", text: "Cap and wait until 1:00", duration: 30 },{ action: "press", text: "Flip, swirl, and press for 30 seconds", duration: 30 },{ action: "pour", text: "Add 100–120g hot water to taste", waterTo: 270, waterAdd: 120, duration: 15 },{ action: "wait", text: "Serve", duration: 15 }] },
  { id: "champ-33", name: "Hatch 2015 — 2nd", credit: "Nick Hatch, Canada (WAC 2015)", category: "Championship", year: 2015, coffeeG: 20, waterG: 230, tempC: 78, grind: "Fine", method: "Inverted", totalTime: 100, steps: [{ action: "pour", text: "Pour 50g water to bloom", waterTo: 50, waterAdd: 50, duration: 10 },{ action: "stir", text: "Stir gently", duration: 5 },{ action: "wait", text: "Bloom 30 seconds", duration: 25 },{ action: "pour", text: "Add rest of water to 230g in 60 seconds", waterTo: 230, waterAdd: 180, duration: 30 },{ action: "press", text: "Flip and press for 30 seconds", duration: 30 }] },
  // ─── NEW: Classic extras ───
  { id: "classic-16", name: "Japanese Iced AeroPress", credit: "Community recipe", category: "Classic", coffeeG: 18, waterG: 240, tempC: 96, grind: "Medium-fine", method: "Inverted", totalTime: 90, steps: [{ action: "pour", text: "Place 120g ice in serving glass. Pour 120g hot water over grounds", waterTo: 120, waterAdd: 120, duration: 10 },{ action: "stir", text: "Stir 5 times", duration: 10 },{ action: "wait", text: "Steep", duration: 30 },{ action: "press", text: "Flip and press directly over ice", duration: 30 },{ action: "stir", text: "Stir to chill, add ice if needed", duration: 10 }] },
  { id: "classic-17", name: "The Concentrate + Milk", credit: "Community recipe", category: "Classic", coffeeG: 20, waterG: 80, tempC: 92, grind: "Fine", method: "Inverted", totalTime: 90, steps: [{ action: "pour", text: "Pour 80g water over grounds", waterTo: 80, waterAdd: 80, duration: 10 },{ action: "stir", text: "Stir firmly 10 times", duration: 10 },{ action: "wait", text: "Steep", duration: 40 },{ action: "press", text: "Flip and press into your favorite mug", duration: 30 }] },
  { id: "classic-18", name: "The Patient Pour", credit: "Community recipe", category: "Classic", coffeeG: 15, waterG: 220, tempC: 86, grind: "Medium-coarse", method: "Standard", totalTime: 180, steps: [{ action: "pour", text: "Pour 55g water slowly", waterTo: 55, waterAdd: 55, duration: 15 },{ action: "wait", text: "Bloom for 30 seconds", duration: 30 },{ action: "pour", text: "Pour another 55g", waterTo: 110, waterAdd: 55, duration: 15 },{ action: "wait", text: "Wait 30 seconds", duration: 30 },{ action: "pour", text: "Pour another 55g", waterTo: 165, waterAdd: 55, duration: 15 },{ action: "wait", text: "Wait 30 seconds", duration: 30 },{ action: "pour", text: "Final pour to 220g", waterTo: 220, waterAdd: 55, duration: 15 },{ action: "press", text: "Press gently", duration: 20 }] },
  { id: "classic-19", name: "The Quick & Strong", credit: "Community recipe", category: "Classic", coffeeG: 17, waterG: 190, tempC: 95, grind: "Fine", method: "Standard", totalTime: 60, steps: [{ action: "pour", text: "Pour all water quickly", waterTo: 190, waterAdd: 190, duration: 10 },{ action: "stir", text: "Stir vigorously 10 times", duration: 10 },{ action: "press", text: "Press immediately — no wait", duration: 30 },{ action: "wait", text: "Serve", duration: 10 }] },
  { id: "classic-20", name: "The Long Steep", credit: "Community recipe", category: "Classic", coffeeG: 14, waterG: 210, tempC: 82, grind: "Medium", method: "Inverted", totalTime: 300, steps: [{ action: "pour", text: "Pour all water", waterTo: 210, waterAdd: 210, duration: 10 },{ action: "stir", text: "Stir gently 3 times", duration: 10 },{ action: "wait", text: "Walk away — steep 4 minutes", duration: 240 },{ action: "press", text: "Flip and press slowly", duration: 30 },{ action: "wait", text: "Let cool slightly and serve", duration: 10 }] },
];

const actionColor = { pour: C.teal, stir: C.amber, wait: C.subtle, press: C.sage };
const actionIcon = { pour: "\u{1F4A7}", stir: "\u{1F504}", wait: "\u{231B}", press: "\u{2B07}\u{FE0F}" };

// ─── Audio ─────────────────────────────────────────────────
let audioCtx = null;
const getCtx = () => {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === "suspended") audioCtx.resume();
  return audioCtx;
};
const unlockAudio = () => { try { getCtx(); } catch (e) {} };

// Bell-like tone with harmonics and smooth decay
const playTone = (freq, duration = 0.5, vol = 0.2, delay = 0) => {
  try {
    const ctx = getCtx();
    const t = ctx.currentTime + delay;
    // Fundamental
    const o1 = ctx.createOscillator(); const g1 = ctx.createGain();
    o1.type = "sine"; o1.frequency.value = freq;
    g1.gain.setValueAtTime(vol, t);
    g1.gain.exponentialRampToValueAtTime(0.001, t + duration);
    o1.connect(g1); g1.connect(ctx.destination);
    // Soft overtone for warmth
    const o2 = ctx.createOscillator(); const g2 = ctx.createGain();
    o2.type = "sine"; o2.frequency.value = freq * 2;
    g2.gain.setValueAtTime(vol * 0.15, t);
    g2.gain.exponentialRampToValueAtTime(0.001, t + duration * 0.6);
    o2.connect(g2); g2.connect(ctx.destination);
    // Gentle third harmonic
    const o3 = ctx.createOscillator(); const g3 = ctx.createGain();
    o3.type = "sine"; o3.frequency.value = freq * 3;
    g3.gain.setValueAtTime(vol * 0.05, t);
    g3.gain.exponentialRampToValueAtTime(0.001, t + duration * 0.3);
    o3.connect(g3); g3.connect(ctx.destination);
    [o1, o2, o3].forEach((o) => { o.start(t); o.stop(t + duration); });
  } catch (e) {}
};

// Step transition: warm two-note chime (D5 → A5)
const playChime = () => {
  playTone(587, 0.4, 0.2, 0);
  playTone(880, 0.5, 0.18, 0.12);
};

// Brew complete: celebratory ascending triad (D5 → F#5 → A5) with sustain
const playComplete = () => {
  playTone(587, 0.6, 0.2, 0);
  playTone(740, 0.6, 0.2, 0.18);
  playTone(880, 0.9, 0.22, 0.36);
};

// Countdown tick: soft wooden knock
const playTick = () => {
  try {
    const ctx = getCtx();
    const t = ctx.currentTime;
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type = "sine"; o.frequency.setValueAtTime(440, t);
    o.frequency.exponentialRampToValueAtTime(220, t + 0.08);
    g.gain.setValueAtTime(0.15, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + 0.12);
    o.connect(g); g.connect(ctx.destination);
    o.start(t); o.stop(t + 0.12);
  } catch (e) {}
};

// ─── Storage ───────────────────────────────────────────────
const loadData = () => { try { return JSON.parse(localStorage.getItem("cbtr-data")) || { favorites: [], ratings: {}, notes: {}, customRecipes: [], grinder: "none" }; } catch { return { favorites: [], ratings: {}, notes: {}, customRecipes: [], grinder: "none" }; } };
const saveData = (d) => localStorage.setItem("cbtr-data", JSON.stringify(d));

// ─── Landscape SVG ─────────────────────────────────────────
const Landscape = () => (
  <svg viewBox="0 0 480 80" style={{ width: "100%", height: 65, display: "block" }} preserveAspectRatio="none">
    <g stroke="#C4887A" strokeWidth="0.8" fill="none" opacity="0.45">
      <polygon points="0,48 30,18 60,48" /><polygon points="30,48 65,10 100,48" />
      <polygon points="80,48 120,5 160,48" /><polygon points="140,48 175,15 210,48" />
      <polygon points="190,48 230,8 270,48" /><polygon points="250,48 285,18 320,48" />
      <polygon points="300,48 340,3 380,48" /><polygon points="360,48 400,14 440,48" />
      <polygon points="420,48 455,20 480,48" />
      <line x1="65" y1="10" x2="65" y2="48" /><line x1="120" y1="5" x2="120" y2="48" />
      <line x1="230" y1="8" x2="230" y2="48" /><line x1="340" y1="3" x2="340" y2="48" />
    </g>
    <g stroke="#C45D3E" strokeWidth="1" fill="none" opacity="0.5">
      <polygon points="20,48 55,22 90,48" /><polygon points="70,48 110,12 150,48" />
      <polygon points="130,48 170,20 210,48" /><polygon points="200,48 245,10 290,48" />
      <polygon points="270,48 310,16 350,48" /><polygon points="330,48 370,8 410,48" />
      <polygon points="390,48 430,22 470,48" />
      <line x1="110" y1="12" x2="130" y2="48" /><line x1="245" y1="10" x2="245" y2="48" /><line x1="370" y1="8" x2="370" y2="48" />
    </g>
    <g stroke="#A84828" strokeWidth="1.2" fill="none" opacity="0.55">
      <polygon points="10,48 50,28 90,48" /><polygon points="100,48 145,18 190,48" />
      <polygon points="180,48 225,24 270,48" /><polygon points="260,48 305,14 350,48" />
      <polygon points="340,48 385,26 430,48" /><polygon points="410,48 450,30 480,48" />
      <line x1="50" y1="28" x2="50" y2="48" /><line x1="145" y1="18" x2="145" y2="48" /><line x1="305" y1="14" x2="305" y2="48" />
    </g>
    <line x1="0" y1="48" x2="480" y2="48" stroke="#D4960A" strokeWidth="0.7" opacity="0.5" />
    <g stroke="#2878A8" strokeWidth="0.9" fill="none" opacity="0.5">
      <path d="M0,56 Q12,50 24,56 Q36,50 48,56 Q60,50 72,56 Q84,50 96,56 Q108,50 120,56 Q132,50 144,56 Q156,50 168,56 Q180,50 192,56 Q204,50 216,56 Q228,50 240,56 Q252,50 264,56 Q276,50 288,56 Q300,50 312,56 Q324,50 336,56 Q348,50 360,56 Q372,50 384,56 Q396,50 408,56 Q420,50 432,56 Q444,50 456,56 Q468,50 480,56" />
    </g>
    <g stroke="#3A9DB8" strokeWidth="0.8" fill="none" opacity="0.4">
      <path d="M-12,62 Q0,55 12,62 Q24,55 36,62 Q48,55 60,62 Q72,55 84,62 Q96,55 108,62 Q120,55 132,62 Q144,55 156,62 Q168,55 180,62 Q192,55 204,62 Q216,55 228,62 Q240,55 252,62 Q264,55 276,62 Q288,55 300,62 Q312,55 324,62 Q336,55 348,62 Q360,55 372,62 Q384,55 396,62 Q408,55 420,62 Q432,55 444,62 Q456,55 468,62 Q480,55 492,62" />
    </g>
    <g stroke="#88C0D8" strokeWidth="0.7" fill="none" opacity="0.3">
      <path d="M6,68 Q18,62 30,68 Q42,62 54,68 Q66,62 78,68 Q90,62 102,68 Q114,62 126,68 Q138,62 150,68 Q162,62 174,68 Q186,62 198,68 Q210,62 222,68 Q234,62 246,68 Q258,62 270,68 Q282,62 294,68 Q306,62 318,68 Q330,62 342,68 Q354,62 366,68 Q378,62 390,68 Q402,62 414,68 Q426,62 438,68 Q450,62 462,68 Q474,62 486,68" />
    </g>
    <g stroke="#B8D8E8" strokeWidth="0.5" fill="none" opacity="0.2">
      <path d="M0,74 Q15,67 30,74 Q45,67 60,74 Q75,67 90,74 Q105,67 120,74 Q135,67 150,74 Q165,67 180,74 Q195,67 210,74 Q225,67 240,74 Q255,67 270,74 Q285,67 300,74 Q315,67 330,74 Q345,67 360,74 Q375,67 390,74 Q405,67 420,74 Q435,67 450,74 Q465,67 480,74" />
    </g>
  </svg>
);

// ═══════════════════════════════════════════════════════════
function App() {
  const [screen, setScreen] = useState("home");
  const [activeTab, setActiveTab] = useState("Classic");
  const [recipe, setRecipe] = useState(null);
  const [data, setData] = useState(loadData);
  const [showNotes, setShowNotes] = useState(false);
  const [noteText, setNoteText] = useState("");
  const [showWelcome, setShowWelcome] = useState(() => { try { return !localStorage.getItem("cbtr-welcomed"); } catch { return true; } });
  const [showSettings, setShowSettings] = useState(false);
  const loadTabSort = (tab) => { try { const p = JSON.parse(localStorage.getItem("cbtr-sort")) || {}; return p[tab] || { by: "default", rev: false }; } catch { return { by: "default", rev: false }; } };
  const saveTabSort = (tab, by, rev) => { try { const p = JSON.parse(localStorage.getItem("cbtr-sort")) || {}; p[tab] = { by, rev }; localStorage.setItem("cbtr-sort", JSON.stringify(p)); } catch {} };
  const initSort = loadTabSort("Classic");
  const [sortBy, setSortBy] = useState(initSort.by);
  const [sortReversed, setSortReversed] = useState(initSort.rev);
  const [brewStep, setBrewStep] = useState(0);
  const [stepTime, setStepTime] = useState(0);
  const [elapsed, setElapsed] = useState(0);
  const [isBrewing, setIsBrewing] = useState(false);
  const [brewDone, setBrewDone] = useState(false);
  const [silenced, setSilenced] = useState(false);
  const [countdown, setCountdown] = useState(0);
  const [showScrollTop, setShowScrollTop] = useState(false);
  const [doneRating, setDoneRating] = useState(0);
  const [doneNote, setDoneNote] = useState("");
  const [building, setBuilding] = useState(false);
  const [editId, setEditId] = useState(null);
  const emptyForm = { name: "", coffeeG: "", waterG: "", tempC: "", grind: "", method: "Standard", steps: [] };
  const emptyStep = { action: "pour", text: "", waterTo: "", waterAdd: "", duration: "" };
  const [form, setForm] = useState(emptyForm);
  const [sf, setSf] = useState(emptyStep);
  const timerRef = useRef(null);
  const wakeRef = useRef(null);

  // ─── Auth State ───────────────────────────────────────
  const [token, setToken] = useState(() => { try { return localStorage.getItem("cbtr-token") || ""; } catch { return ""; } });
  const [user, setUser] = useState(() => { try { return JSON.parse(localStorage.getItem("cbtr-user")) || null; } catch { return null; } });
  const [authScreen, setAuthScreen] = useState(null); // null, "login", "register"
  const [authError, setAuthError] = useState("");
  const [authLoading, setAuthLoading] = useState(false);
  const [syncing, setSyncing] = useState(false);

  const isLoggedIn = !!token && !!user;

  // ─── API Helper ───────────────────────────────────────
  const api = async (path, method = "GET", body = null, tokenOverride = null) => {
    try {
      const tk = tokenOverride || token;
      const opts = { method, headers: { "Content-Type": "application/json" } };
      if (tk) opts.headers["Authorization"] = `Bearer ${tk}`;
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(`${API}${path}`, opts);
      const json = await res.json();
      if (!res.ok) throw new Error(json.error || "Request failed");
      return json;
    } catch (err) {
      console.error(`API ${method} ${path}:`, err.message);
      return null;
    }
  };

  // ─── Sync from server on login / app load ─────────────
  const syncFromServer = async (tk = null) => {
    const useToken = tk || token;
    if (!useToken) return;
    setSyncing(true);
    const result = await api("/sync", "GET", null, useToken);
    if (result) {
      setData((p) => ({ ...p, favorites: result.favorites, ratings: result.ratings, notes: result.notes, customRecipes: result.customRecipes, grinder: result.grinder }));
    }
    setSyncing(false);
  };

  // Auto-sync on app load if logged in
  useEffect(() => { if (isLoggedIn) syncFromServer(); }, []);

  // ─── Auth Actions ─────────────────────────────────────
  const doRegister = async (email, password, displayName) => {
    setAuthLoading(true); setAuthError("");
    const result = await api("/register", "POST", { email, password, displayName });
    setAuthLoading(false);
    if (!result) { setAuthError("Connection failed. Check your internet."); return; }
    if (result.error) { setAuthError(result.error); return; }
    setToken(result.token); setUser(result.user);
    localStorage.setItem("cbtr-token", result.token);
    localStorage.setItem("cbtr-user", JSON.stringify(result.user));
    setAuthScreen(null);
    syncFromServer(result.token);
  };

  const doLogin = async (email, password) => {
    setAuthLoading(true); setAuthError("");
    const result = await api("/login", "POST", { email, password });
    setAuthLoading(false);
    if (!result) { setAuthError("Connection failed. Check your internet."); return; }
    if (result.error) { setAuthError(result.error); return; }
    setToken(result.token); setUser(result.user);
    localStorage.setItem("cbtr-token", result.token);
    localStorage.setItem("cbtr-user", JSON.stringify(result.user));
    setAuthScreen(null);
    syncFromServer(result.token);
  };

  const doLogout = () => {
    setToken(""); setUser(null);
    localStorage.removeItem("cbtr-token");
    localStorage.removeItem("cbtr-user");
  };

  useEffect(() => { saveData(data); }, [data]);

  const grinder = data.grinder || "none";
  const setGrinder = (g) => { setData((p) => ({ ...p, grinder: g })); if (isLoggedIn) api("/grinder", "PUT", { grinder: g }); };

  const all = [...RECIPES, ...data.customRecipes.map((r) => ({ ...r, isCustom: true }))];
  const tabs = ["Classic", "Championship", "Favorites", "My Recipes", "Espresso-style"];

  let filtered = activeTab === "Favorites" ? all.filter((r) => data.favorites.includes(r.id)) : activeTab === "My Recipes" ? data.customRecipes : all.filter((r) => r.category === activeTab);

  // Sorting
  const dir = sortReversed ? -1 : 1;
  if (sortBy === "alpha") filtered = [...filtered].sort((a, b) => dir * a.name.localeCompare(b.name));
  else if (sortBy === "rating") filtered = [...filtered].sort((a, b) => dir * ((data.ratings[b.id] || 0) - (data.ratings[a.id] || 0)));
  else if (sortBy === "temp") filtered = [...filtered].sort((a, b) => dir * (a.tempC - b.tempC));
  else if (sortBy === "coffee") filtered = [...filtered].sort((a, b) => dir * (a.coffeeG - b.coffeeG));
  else if (sortBy === "grind") filtered = [...filtered].sort((a, b) => dir * (grindRank(a.grind) - grindRank(b.grind)));
  else if (sortBy === "method") filtered = [...filtered].sort((a, b) => dir * (a.method === "Standard" ? -1 : 1) - dir * (b.method === "Standard" ? -1 : 1));
  else if (sortBy === "year") filtered = [...filtered].sort((a, b) => dir * ((b.year || 0) - (a.year || 0)));
  else if (sortBy === "place") filtered = [...filtered].sort((a, b) => dir * (getPlace(a.name) - getPlace(b.name)));

  const wakeLock = async () => { try { if ("wakeLock" in navigator) wakeRef.current = await navigator.wakeLock.request("screen"); } catch {} };
  const wakeRelease = () => { if (wakeRef.current) { wakeRef.current.release(); wakeRef.current = null; } };

  useEffect(() => {
    if (isBrewing && recipe) {
      timerRef.current = setInterval(() => {
        setStepTime((p) => {
          if (p <= 1) {
            const next = brewStep + 1;
            if (next >= recipe.steps.length) { clearInterval(timerRef.current); setIsBrewing(false); setBrewDone(true); if (!silenced) playComplete(); wakeRelease(); return 0; }
            setBrewStep(next); if (!silenced) playChime(); return recipe.steps[next].duration;
          }
          return p - 1;
        });
        setElapsed((p) => p + 1);
      }, 1000);
    }
    return () => clearInterval(timerRef.current);
  }, [isBrewing, brewStep, recipe, silenced]);

  // Scroll-to-top listener
  useEffect(() => {
    const onScroll = () => setShowScrollTop(window.scrollY > 400);
    window.addEventListener("scroll", onScroll);
    return () => window.removeEventListener("scroll", onScroll);
  }, []);

  // Countdown timer
  useEffect(() => {
    if (countdown <= 0) return;
    if (!silenced) playTick();
    const t = setTimeout(() => {
      if (countdown === 1) {
        setCountdown(0);
        setIsBrewing(true);
      } else {
        setCountdown(countdown - 1);
      }
    }, 1000);
    return () => clearTimeout(t);
  }, [countdown]);

  const startBrew = () => { unlockAudio(); setBrewStep(0); setStepTime(recipe.steps[0].duration); setElapsed(0); setIsBrewing(false); setBrewDone(false); setDoneRating(data.ratings[recipe.id] || 0); setDoneNote(data.notes[recipe.id] || ""); setScreen("brew"); setCountdown(3); wakeLock(); };
  const cancelBrew = () => { clearInterval(timerRef.current); setIsBrewing(false); setBrewDone(false); setCountdown(0); wakeRelease(); setScreen("detail"); };
  const toggleFav = (id) => { setData((p) => ({ ...p, favorites: p.favorites.includes(id) ? p.favorites.filter((f) => f !== id) : [...p.favorites, id] })); if (isLoggedIn) api("/favorites", "PUT", { recipeId: id }); };
  const rate = (id, r) => { setData((p) => ({ ...p, ratings: { ...p.ratings, [id]: r } })); if (isLoggedIn) api("/ratings", "PUT", { recipeId: id, rating: r }); };
  const saveNt = (id, n) => { setData((p) => ({ ...p, notes: { ...p.notes, [id]: n } })); if (isLoggedIn) api("/notes", "PUT", { recipeId: id, noteText: n }); };
  const saveDone = () => { if (doneRating > 0) rate(recipe.id, doneRating); if (doneNote.trim()) saveNt(recipe.id, doneNote); setScreen("detail"); setBrewDone(false); };
  const exportD = () => { const b = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" }); const u = URL.createObjectURL(b); const a = document.createElement("a"); a.href = u; const d = new Date().toISOString().slice(0, 10); a.download = `aeropress-backup-${d}.json`; a.click(); URL.revokeObjectURL(u); };
  const importD = (e) => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if (d.favorites && d.ratings) { setData(d); if (isLoggedIn) { d.favorites.forEach((id) => api("/favorites", "PUT", { recipeId: id })); Object.entries(d.ratings).forEach(([id, r]) => api("/ratings", "PUT", { recipeId: id, rating: r })); Object.entries(d.notes).forEach(([id, n]) => { if (n) api("/notes", "PUT", { recipeId: id, noteText: n }); }); if (d.grinder) api("/grinder", "PUT", { grinder: d.grinder }); } } } catch {} }; r.readAsText(f); };
  const saveCustom = () => { const r = { ...form, id: editId || `custom-${Date.now()}`, coffeeG: parseFloat(form.coffeeG) || 0, waterG: parseFloat(form.waterG) || 0, tempC: parseFloat(form.tempC) || 0, category: "My Recipes", credit: "My recipe", totalTime: form.steps.reduce((s, st) => s + (parseInt(st.duration) || 0), 0), steps: form.steps.map((s) => ({ ...s, duration: parseInt(s.duration) || 0, waterTo: s.waterTo ? parseFloat(s.waterTo) : undefined, waterAdd: s.waterAdd ? parseFloat(s.waterAdd) : undefined })) }; setData((p) => { const idx = p.customRecipes.findIndex((x) => x.id === r.id); const u = [...p.customRecipes]; if (idx >= 0) u[idx] = r; else u.push(r); return { ...p, customRecipes: u }; }); if (isLoggedIn) { const body = { recipeId: r.id, name: r.name, coffeeG: r.coffeeG, waterG: r.waterG, tempC: r.tempC, grind: r.grind, method: r.method, steps: r.steps }; if (editId) api("/recipes", "PUT", body); else api("/recipes", "POST", body); } setBuilding(false); setEditId(null); setForm(emptyForm); };
  const deleteCustom = (id) => { setData((p) => ({ ...p, customRecipes: p.customRecipes.filter((r) => r.id !== id), favorites: p.favorites.filter((f) => f !== id) })); if (isLoggedIn) api(`/recipes/${id}`, "DELETE"); setScreen("home"); };
  const editCustom = (r) => { setEditId(r.id); setForm({ name: r.name, coffeeG: String(r.coffeeG), waterG: String(r.waterG), tempC: String(r.tempC), grind: r.grind, method: r.method, steps: r.steps.map((s) => ({ ...s, duration: String(s.duration), waterTo: s.waterTo ? String(s.waterTo) : "", waterAdd: s.waterAdd ? String(s.waterAdd) : "" })) }); setBuilding(true); };
  const addStep = () => { if (!sf.text || !sf.duration) return; setForm((p) => ({ ...p, steps: [...p.steps, { ...sf }] })); setSf(emptyStep); };

  const catBorder = (cat) => cat === "Championship" ? C.terra : cat === "Espresso-style" ? C.gold : C.accent;
  const grindLabel = (g) => { const num = getGrindNum(grinder, g); return num ? `${g} (${GRINDERS[grinder].short}: ${num})` : g; };
  const grindPill = (g) => { const num = getGrindNum(grinder, g); return num ? `${GRINDERS[grinder].short}: ${num}` : g; };

  const S = {
    app: { background: C.bg, minHeight: "100vh", color: C.text, fontFamily: "-apple-system, 'Segoe UI', Roboto, sans-serif", maxWidth: 480, margin: "0 auto", paddingBottom: 30 },
    input: { background: C.inputBg, border: `1px solid ${C.border}`, borderRadius: 8, padding: "10px 12px", color: C.text, fontSize: 14, width: "100%", boxSizing: "border-box" },
    select: { background: C.inputBg, border: `1px solid ${C.border}`, borderRadius: 8, padding: "10px 12px", color: C.text, fontSize: 14, width: "100%", boxSizing: "border-box" },
    label: { fontSize: 12, color: C.subtle, marginBottom: 4, display: "block" },
    primaryBtn: { background: `linear-gradient(135deg, ${C.terra}, ${C.accent})`, color: "#fff", border: "none", borderRadius: 10, padding: "16px 0", fontSize: 18, fontWeight: 700, width: "100%", cursor: "pointer", marginTop: 12, letterSpacing: 0.5 },
    cancelBtn: { background: C.cancel, color: "#fff", border: "none", borderRadius: 10, padding: "12px 24px", fontSize: 14, fontWeight: 600, cursor: "pointer" },
    secBtn: { background: C.card, color: C.text, border: `1px solid ${C.border}`, borderRadius: 8, padding: "10px 16px", fontSize: 13, fontWeight: 600, cursor: "pointer", boxShadow: C.shadow },
    star: (on) => ({ background: "none", border: "none", fontSize: 22, cursor: "pointer", color: on ? C.amber : C.border, padding: 0, lineHeight: 1 }),
  };

  const Welcome = () => (
    <div style={{ padding: "0 16px 6px" }}>
      <div style={{ background: C.card, borderRadius: 14, padding: "18px 16px", border: `1px solid ${C.border}`, boxShadow: C.shadow }}>
        <p style={{ color: C.text, fontSize: 14, lineHeight: 1.7, margin: 0, fontWeight: 500 }}>Pick a recipe, follow the step-by-step guided timer, and brew a better cup. Use the ⚙ Grinder button to see grind settings for your specific grinder. Build your own recipes in the My Recipes tab. Sort, rate, and add personal tasting notes to any recipe.</p>
        <div style={{ width: 40, height: 2, background: C.terra, margin: "12px 0", borderRadius: 1 }} />
        <p style={{ color: C.subtle, fontSize: 13, lineHeight: 1.7, margin: 0 }}>Curated AeroPress recipes from World Championship winners, renowned baristas, and the coffee community. Designed collaboratively by Tochina and Claude AI.</p>
        <button onClick={() => { setShowWelcome(false); try { localStorage.setItem("cbtr-welcomed", "1"); } catch {} }} style={{ background: "none", border: "none", color: C.accent, fontSize: 13, cursor: "pointer", padding: "8px 0 0", fontWeight: 600 }}>Dismiss</button>
      </div>
    </div>
  );

  const Settings = () => (
    <div style={{ padding: "0 16px 10px" }}>
      <div style={{ background: C.card, borderRadius: 14, padding: "16px", border: `1px solid ${C.border}`, boxShadow: C.shadow }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
          <h3 style={{ margin: 0, fontSize: 15, color: C.text }}>Grinder</h3>
          <button onClick={() => setShowSettings(false)} style={{ background: "none", border: "none", color: C.subtle, cursor: "pointer", fontSize: 18 }}>✕</button>
        </div>
        <p style={{ fontSize: 12, color: C.subtle, margin: "0 0 10px" }}>Select your grinder to see approximate setting numbers with each recipe. Numbers are starting points — adjust to taste.</p>
        <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
          {Object.entries(GRINDERS).map(([key, val]) => (
            <button key={key} onClick={() => setGrinder(key)}
              style={{ background: grinder === key ? C.accent : C.inputBg, color: grinder === key ? "#fff" : C.text, border: `1px solid ${grinder === key ? C.accent : C.border}`, borderRadius: 8, padding: "10px 12px", fontSize: 14, cursor: "pointer", textAlign: "left", fontWeight: grinder === key ? 600 : 400 }}>
              {val.name}
            </button>
          ))}
        </div>
      </div>
    </div>
  );

  // ─── Auth Screen ─────────────────────────────────────
  const AuthScreen = () => {
    const [email, setEmail] = useState("");
    const [password, setPassword] = useState("");
    const [displayName, setDisplayName] = useState("");
    const isReg = authScreen === "register";
    const submit = () => { if (isReg) doRegister(email, password, displayName); else doLogin(email, password); };
    return (
      <div style={{ padding: "0 16px 10px" }}>
        <div style={{ background: C.card, borderRadius: 14, padding: "20px 16px", border: `1px solid ${C.border}`, boxShadow: C.shadow }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 14 }}>
            <h3 style={{ margin: 0, fontSize: 17, color: C.accent }}>{isReg ? "Create Account" : "Sign In"}</h3>
            <button onClick={() => { setAuthScreen(null); setAuthError(""); }} style={{ background: "none", border: "none", color: C.subtle, cursor: "pointer", fontSize: 18 }}>✕</button>
          </div>
          {authError && <p style={{ color: C.cancel, fontSize: 13, margin: "0 0 10px", padding: "8px 12px", background: "#FFF0EF", borderRadius: 8 }}>{authError}</p>}
          {isReg && <div style={{ marginBottom: 10 }}><label style={S.label}>Display Name</label><input style={S.input} placeholder="Tochina" value={displayName} onChange={(e) => setDisplayName(e.target.value)} /></div>}
          <div style={{ marginBottom: 10 }}><label style={S.label}>Email</label><input style={S.input} type="email" placeholder="you@example.com" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
          <div style={{ marginBottom: 14 }}><label style={S.label}>Password</label><input style={S.input} type="password" placeholder="••••••••" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={(e) => e.key === "Enter" && submit()} /></div>
          <button style={{ ...S.primaryBtn, marginTop: 0, opacity: authLoading ? 0.6 : 1 }} onClick={submit} disabled={authLoading || !email || !password}>{authLoading ? "..." : isReg ? "Create Account" : "Sign In"}</button>
          <p style={{ textAlign: "center", fontSize: 13, color: C.subtle, marginTop: 12 }}>
            {isReg ? "Already have an account? " : "Need an account? "}
            <button onClick={() => { setAuthScreen(isReg ? "login" : "register"); setAuthError(""); }} style={{ background: "none", border: "none", color: C.accent, cursor: "pointer", fontSize: 13, fontWeight: 600, padding: 0 }}>{isReg ? "Sign in" : "Create one"}</button>
          </p>
        </div>
      </div>
    );
  };

  // ═══ HOME ════════════════════════════════════════════
  if (screen === "home") {
    return (
      <div style={S.app}>
        <div style={{ textAlign: "center", padding: "20px 16px 2px" }}>
          <h1 style={{ fontSize: 24, fontWeight: 800, color: C.accent, letterSpacing: 0.3, margin: 0 }}>AeroPress Recipes & Timer</h1>
          <p style={{ fontSize: 12, color: C.terra, margin: "3px 0 0", letterSpacing: 1.5, fontStyle: "italic" }}>Bo's Third Brew</p>
          <div style={{ display: "flex", justifyContent: "center", gap: 16, marginTop: 6, flexWrap: "wrap" }}>
            <button onClick={() => setShowWelcome(true)} style={{ background: "none", border: "none", color: C.subtle, fontSize: 12, cursor: "pointer", opacity: 0.7 }}>About</button>
            <button onClick={() => setShowSettings(!showSettings)} style={{ background: "none", border: "none", color: C.subtle, fontSize: 12, cursor: "pointer", opacity: 0.7 }}>⚙ Grinder</button>
            {isLoggedIn ? (
              <button onClick={doLogout} style={{ background: "none", border: "none", color: C.subtle, fontSize: 12, cursor: "pointer", opacity: 0.7 }}>Sign out ({user.displayName || user.email})</button>
            ) : (
              <button onClick={() => setAuthScreen("login")} style={{ background: "none", border: "none", color: C.accent, fontSize: 12, cursor: "pointer", fontWeight: 600 }}>Sign in</button>
            )}
          </div>
          {syncing && <p style={{ fontSize: 11, color: C.teal, margin: "4px 0 0" }}>Syncing...</p>}
        </div>
        <Landscape />
        {showWelcome && <Welcome />}
        {showSettings && <Settings />}
        {authScreen && <AuthScreen />}
        <div style={{ display: "flex", overflowX: "auto", borderBottom: `1px solid ${C.border}`, scrollbarWidth: "none" }}>
          {tabs.map((t) => {
            const cnt = t === "Favorites" ? all.filter((r) => data.favorites.includes(r.id)).length : t === "My Recipes" ? data.customRecipes.length : all.filter((r) => r.category === t).length;
            return (
            <button key={t} onClick={() => { const s = loadTabSort(t); const validSort = (s.by === "year" || s.by === "place") && t !== "Championship" ? "default" : s.by; setSortBy(validSort); setSortReversed(validSort === "default" ? false : s.rev); setActiveTab(t); setBuilding(false); }}
              style={{ padding: "10px 13px", fontSize: 12, fontWeight: activeTab === t ? 700 : 400, color: activeTab === t ? C.accent : C.subtle, borderBottom: activeTab === t ? `2px solid ${C.accent}` : "2px solid transparent", background: "none", border: "none", cursor: "pointer", whiteSpace: "nowrap", flexShrink: 0 }}>
              {t === "Favorites" ? `★ ${t}` : t}{cnt > 0 ? ` (${cnt})` : ""}
            </button>
          );})}
        </div>
        {/* Sort bar */}
        {!building && filtered.length > 1 && (
          <div style={{ padding: "8px 14px 0", display: "flex", alignItems: "center", gap: 8 }}>
            <span style={{ fontSize: 12, color: C.subtle }}>Sort:</span>
            <select value={sortBy} onChange={(e) => { const v = e.target.value; setSortBy(v); setSortReversed(false); saveTabSort(activeTab, v, false); }} style={{ ...S.select, width: "auto", padding: "5px 10px", fontSize: 12 }}>
              <option value="default">Default</option>
              <option value="alpha">A → Z</option>
              <option value="rating">Highest rated</option>
              <option value="temp">Temp</option>
              <option value="coffee">Coffee amount</option>
              <option value="grind">Grind level</option>
              <option value="method">Method</option>
              {activeTab === "Championship" && <option value="year">Year</option>}
              {activeTab === "Championship" && <option value="place">Place</option>}
            </select>
            {sortBy !== "default" && (
              <button onClick={() => { const nr = !sortReversed; setSortReversed(nr); saveTabSort(activeTab, sortBy, nr); }} title={sortReversed ? "Reversed" : "Normal order"} style={{ background: C.inputBg, border: `1px solid ${C.border}`, borderRadius: 8, padding: "4px 10px", fontSize: 14, cursor: "pointer", color: C.accent, fontWeight: 700, lineHeight: 1 }}>
                {sortReversed ? "▲" : "▼"}
              </button>
            )}
          </div>
        )}
        {activeTab === "My Recipes" && !building && <div style={{ padding: "12px 14px 0" }}><button style={{ ...S.primaryBtn, marginTop: 0 }} onClick={() => { setForm(emptyForm); setBuilding(true); setEditId(null); }}>+ New Recipe</button></div>}
        {activeTab === "My Recipes" && building && (
          <div style={{ padding: 14 }}>
            <h3 style={{ color: C.accent, margin: "0 0 12px", fontSize: 16 }}>{editId ? "Edit Recipe" : "New Recipe"}</h3>
            <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
              <div><label style={S.label}>Recipe Name</label><input style={S.input} placeholder="My morning brew" value={form.name} onChange={(e) => setForm((p) => ({ ...p, name: e.target.value }))} /></div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                <div><label style={S.label}>Coffee (g)</label><input style={S.input} type="number" value={form.coffeeG} onChange={(e) => setForm((p) => ({ ...p, coffeeG: e.target.value }))} /></div>
                <div><label style={S.label}>Water (g)</label><input style={S.input} type="number" value={form.waterG} onChange={(e) => setForm((p) => ({ ...p, waterG: e.target.value }))} /></div>
                <div><label style={S.label}>Temp (°F)</label><input style={S.input} type="number" value={form.tempC} onChange={(e) => setForm((p) => ({ ...p, tempC: e.target.value }))} /></div>
                <div><label style={S.label}>Grind</label><input style={S.input} value={form.grind} onChange={(e) => setForm((p) => ({ ...p, grind: e.target.value }))} /></div>
              </div>
              <div><label style={S.label}>Method</label><select style={S.select} value={form.method} onChange={(e) => setForm((p) => ({ ...p, method: e.target.value }))}><option>Standard</option><option>Inverted</option></select></div>
              <h4 style={{ color: C.text, margin: "8px 0 4px", fontSize: 14 }}>Steps</h4>
              {form.steps.map((s, i) => (
                <div key={i} style={{ background: C.inputBg, padding: "8px 12px", borderRadius: 8, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                  <span style={{ fontSize: 13 }}><span style={{ color: actionColor[s.action] }}>{actionIcon[s.action]}</span> {s.text} ({s.duration}s){s.waterTo && <span style={{ color: C.subtle }}> — {s.waterTo}g (+{s.waterAdd}g)</span>}</span>
                  <button onClick={() => setForm((p) => ({ ...p, steps: p.steps.filter((_, j) => j !== i) }))} style={{ background: "none", border: "none", color: C.cancel, cursor: "pointer", fontSize: 16 }}>✕</button>
                </div>
              ))}
              <div style={{ background: C.inputBg, padding: 12, borderRadius: 8, border: `1px solid ${C.border}` }}>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 8 }}>
                  <div><label style={S.label}>Action</label><select style={S.select} value={sf.action} onChange={(e) => setSf((p) => ({ ...p, action: e.target.value }))}><option value="pour">Pour</option><option value="stir">Stir</option><option value="wait">Wait</option><option value="press">Press</option></select></div>
                  <div><label style={S.label}>Duration (sec)</label><input style={S.input} type="number" value={sf.duration} onChange={(e) => setSf((p) => ({ ...p, duration: e.target.value }))} /></div>
                </div>
                <div style={{ marginBottom: 8 }}><label style={S.label}>Instruction</label><input style={S.input} placeholder="Describe this step" value={sf.text} onChange={(e) => setSf((p) => ({ ...p, text: e.target.value }))} /></div>
                {sf.action === "pour" && <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 8 }}><div><label style={S.label}>Total weight (g)</label><input style={S.input} type="number" value={sf.waterTo} onChange={(e) => setSf((p) => ({ ...p, waterTo: e.target.value }))} /></div><div><label style={S.label}>Added (g)</label><input style={S.input} type="number" value={sf.waterAdd} onChange={(e) => setSf((p) => ({ ...p, waterAdd: e.target.value }))} /></div></div>}
                <button style={{ ...S.secBtn, width: "100%" }} onClick={addStep}>+ Add Step</button>
              </div>
              <div style={{ display: "flex", gap: 10 }}><button style={{ ...S.primaryBtn, flex: 1 }} onClick={saveCustom} disabled={!form.name || form.steps.length === 0}>{editId ? "Save Changes" : "Save Recipe"}</button><button style={{ ...S.cancelBtn, marginTop: 12 }} onClick={() => { setBuilding(false); setEditId(null); setForm(emptyForm); }}>Cancel</button></div>
            </div>
          </div>
        )}
        {!building && filtered.length === 0 && <div style={{ textAlign: "center", padding: 40, color: C.subtle }}>{activeTab === "Favorites" ? "No favorites yet — star a recipe to see it here" : activeTab === "My Recipes" ? "No custom recipes yet" : "No recipes"}</div>}
        {!building && filtered.map((r) => (
          <div key={r.id} style={{ background: C.card, margin: "10px 14px", borderRadius: 12, padding: "14px 16px", cursor: "pointer", borderLeft: `3px solid ${catBorder(r.category)}`, boxShadow: C.shadow }}
            onClick={() => { setRecipe(r); setScreen("detail"); setShowNotes(false); setNoteText(data.notes[r.id] || ""); }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
              <div style={{ flex: 1 }}>
                <p style={{ fontSize: 16, fontWeight: 600, color: C.text, margin: 0 }}>{r.name}</p>
                <p style={{ fontSize: 12, color: C.subtle, margin: "2px 0 0" }}>{r.credit}</p>
              </div>
              <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                {r.year && <span style={{ background: getPlace(r.name) === 1 ? C.gold : getPlace(r.name) === 2 ? C.subtle : C.terra, color: "#fff", fontSize: 10, fontWeight: 700, padding: "2px 7px", borderRadius: 10, whiteSpace: "nowrap" }}>{r.year} · {getPlace(r.name) === 1 ? "1st" : getPlace(r.name) === 2 ? "2nd" : "3rd"}</span>}
                <button style={S.star(data.favorites.includes(r.id))} onClick={(e) => { e.stopPropagation(); toggleFav(r.id); }}>★</button>
              </div>
            </div>
            <div style={{ display: "flex", flexWrap: "wrap", gap: 5, marginTop: 10 }}>
              {[`${r.coffeeG}g`, `${r.waterG}g`, `${cToF(r.tempC)}°F`, grindPill(r.grind), r.method, fmt(r.totalTime)].map((v, i) => (
                <span key={i} style={{ background: C.inputBg, padding: "3px 7px", borderRadius: 6, fontSize: 11, color: C.accent, border: `1px solid ${C.border}` }}>{v}</span>
              ))}
            </div>
            {data.ratings[r.id] > 0 && <div style={{ marginTop: 6 }}>{[1, 2, 3, 4, 5].map((s) => <span key={s} style={{ color: s <= data.ratings[r.id] ? C.amber : C.border, fontSize: 14 }}>★</span>)}</div>}
          </div>
        ))}
        {!building && <div style={{ padding: "24px 14px", display: "flex", gap: 10, justifyContent: "center" }}>
          <button style={S.secBtn} onClick={exportD}>Export Backup</button>
          <label style={{ ...S.secBtn, display: "inline-flex", alignItems: "center", cursor: "pointer" }}>Import Backup<input type="file" accept=".json" onChange={importD} style={{ display: "none" }} /></label>
        </div>}
        {showScrollTop && <button onClick={() => window.scrollTo({ top: 0, behavior: "smooth" })} style={{ position: "fixed", bottom: 24, right: 24, width: 44, height: 44, borderRadius: "50%", background: C.accent, color: "#fff", border: "none", fontSize: 20, cursor: "pointer", boxShadow: "0 3px 12px rgba(0,0,0,0.2)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 50 }}>↑</button>}
      </div>
    );
  }

  // ═══ DETAIL ══════════════════════════════════════════
  if (screen === "detail" && recipe) {
    return (
      <div style={S.app}>
        <div style={{ padding: 14 }}>
          <button onClick={() => setScreen("home")} style={{ background: "none", border: "none", color: C.accent, fontSize: 14, cursor: "pointer", padding: 0, marginBottom: 12 }}>← Back</button>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 4 }}>
            <h2 style={{ color: C.text, margin: 0, fontSize: 22, fontWeight: 700, flex: 1 }}>{recipe.name}</h2>
            <button style={S.star(data.favorites.includes(recipe.id))} onClick={() => toggleFav(recipe.id)}>★</button>
          </div>
          <p style={{ color: C.subtle, fontSize: 13, margin: "2px 0 16px" }}>{recipe.credit}</p>
          <div style={{ background: C.card, borderRadius: 14, padding: 16, marginBottom: 16, borderTop: `3px solid ${C.accent}`, boxShadow: C.shadow }}>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 14 }}>
              {[
                { l: "Coffee", v: `${recipe.coffeeG}g` }, { l: "Water", v: `${recipe.waterG}g` },
                { l: "Temp", v: `${cToF(recipe.tempC)}°F` }, { l: "Grind", v: grindLabel(recipe.grind) },
                { l: "Method", v: recipe.method }, { l: "Time", v: fmt(recipe.totalTime) },
              ].map((x, i) => (
                <div key={i}><div style={{ fontSize: 11, color: C.subtle, marginBottom: 2 }}>{x.l}</div><div style={{ fontSize: 14, fontWeight: 600, color: C.accent }}>{x.v}</div></div>
              ))}
            </div>
          </div>
          <div style={{ marginBottom: 16, display: "flex", alignItems: "center", gap: 12 }}>
            <span style={{ fontSize: 12, color: C.subtle }}>My Rating:</span>
            <div>{[1, 2, 3, 4, 5].map((s) => <button key={s} style={S.star(s <= (data.ratings[recipe.id] || 0))} onClick={() => rate(recipe.id, s)}>★</button>)}</div>
            <button onClick={() => setShowNotes(!showNotes)} style={{ background: "none", border: "none", color: C.subtle, fontSize: 20, cursor: "pointer", marginLeft: "auto" }} title="Notes">📝</button>
          </div>
          {showNotes && <div style={{ marginBottom: 16 }}><textarea style={{ ...S.input, minHeight: 60, resize: "vertical" }} placeholder="Add personal notes..." value={noteText} onChange={(e) => setNoteText(e.target.value)} /><button style={{ ...S.secBtn, marginTop: 6, fontSize: 12 }} onClick={() => { saveNt(recipe.id, noteText); setShowNotes(false); }}>Save Note</button></div>}
          <h3 style={{ color: C.text, fontSize: 14, margin: "0 0 10px", fontWeight: 600 }}>Steps Preview</h3>
          {recipe.steps.map((step, i) => (
            <div key={i} style={{ display: "flex", gap: 10, marginBottom: 10, alignItems: "flex-start" }}>
              <div style={{ width: 32, height: 32, borderRadius: "50%", background: actionColor[step.action], display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, fontWeight: 700, flexShrink: 0, color: "#fff" }}>{i + 1}</div>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 15, color: C.text, lineHeight: 1.4 }}>{step.text}{step.waterTo != null && <span style={{ color: C.teal, fontWeight: 600 }}> — Pour to {step.waterTo}g (+{step.waterAdd}g)</span>}</div>
                <div style={{ fontSize: 12, color: C.subtle }}>{fmt(step.duration)}</div>
              </div>
            </div>
          ))}
          <button style={S.primaryBtn} onClick={startBrew}>Start Brew</button>
          {recipe.isCustom && <div style={{ display: "flex", gap: 10, marginTop: 10 }}><button style={{ ...S.secBtn, flex: 1 }} onClick={() => { editCustom(recipe); setScreen("home"); setActiveTab("My Recipes"); }}>Edit Recipe</button><button style={{ ...S.cancelBtn, flex: 1 }} onClick={() => deleteCustom(recipe.id)}>Delete</button></div>}
        </div>
      </div>
    );
  }

  // ═══ BREW ════════════════════════════════════════════
  if (screen === "brew" && recipe) {
    // Countdown
    if (countdown > 0) {
      const countLabels = { 3: "Ready", 2: "Set", 1: "Go!" };
      return (
        <div style={S.app}>
          <div style={{ padding: "80px 20px", textAlign: "center" }}>
            <p style={{ fontSize: 28, fontWeight: 700, color: C.terra, margin: "0 0 20px", letterSpacing: 2, textTransform: "uppercase" }}>{countLabels[countdown]}</p>
            <div style={{ fontSize: 120, fontWeight: 800, color: C.accent, lineHeight: 1, margin: "10px 0" }}>{countdown}</div>
            <p style={{ fontSize: 16, color: C.subtle, margin: "24px 0 0" }}>{recipe.name}</p>
          </div>
          <div style={{ padding: "30px 20px", textAlign: "center" }}><button style={S.cancelBtn} onClick={() => { setCountdown(0); setIsBrewing(false); wakeRelease(); setScreen("detail"); }}>Cancel</button></div>
        </div>
      );
    }
    const cs = recipe.steps[brewStep];
    if (brewDone) {
      return (
        <div style={S.app}>
          <div style={{ padding: "50px 20px", textAlign: "center" }}>
            <div style={{ fontSize: 56, marginBottom: 12 }}>☕</div>
            <h2 style={{ color: C.sage, fontSize: 30, margin: "0 0 6px", fontWeight: 800 }}>Brew Complete</h2>
            <p style={{ color: C.subtle, fontSize: 15, margin: "0 0 30px" }}>{recipe.name} — {fmt(elapsed)}</p>
            <p style={{ color: C.text, fontSize: 16, marginBottom: 10 }}>How was it?</p>
            <div style={{ marginBottom: 24 }}>{[1, 2, 3, 4, 5].map((s) => <button key={s} style={{ ...S.star(s <= doneRating), fontSize: 36, margin: "0 5px" }} onClick={() => setDoneRating(s)}>★</button>)}</div>
            <textarea style={{ ...S.input, minHeight: 60, resize: "vertical", marginBottom: 16 }} placeholder="Tasting notes, thoughts..." value={doneNote} onChange={(e) => setDoneNote(e.target.value)} />
            <button style={S.primaryBtn} onClick={saveDone}>Save & Done</button>
            <button style={{ ...S.secBtn, width: "100%", marginTop: 10 }} onClick={() => { setScreen("detail"); setBrewDone(false); }}>Skip</button>
          </div>
        </div>
      );
    }
    const pct = cs.duration > 0 ? (1 - stepTime / cs.duration) : 0;
    return (
      <div style={S.app}>
        <div style={{ padding: "14px 16px 0", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <div style={{ fontSize: 13, color: C.subtle }}>Total: <span style={{ color: C.text, fontWeight: 700 }}>{fmt(elapsed)}</span></div>
          <div style={{ fontSize: 13, color: C.subtle }}>Step {brewStep + 1} / {recipe.steps.length}</div>
          <button onClick={() => setSilenced(!silenced)} style={{ background: "none", border: "none", color: silenced ? C.cancel : C.subtle, fontSize: 24, cursor: "pointer" }}>{silenced ? "\u{1F507}" : "\u{1F514}"}</button>
        </div>
        <div style={{ padding: "28px 20px", textAlign: "center" }}>
          <div style={{ display: "inline-block", padding: "5px 20px", borderRadius: 20, background: actionColor[cs.action], color: "#fff", fontSize: 14, fontWeight: 700, letterSpacing: 2, textTransform: "uppercase", marginBottom: 16 }}>{cs.action}</div>
          <div style={{ fontSize: 88, fontWeight: 800, color: C.text, lineHeight: 1, margin: "8px 0", fontVariantNumeric: "tabular-nums" }}>{fmt(stepTime)}</div>
          <div style={{ width: "85%", height: 8, background: C.border, borderRadius: 4, margin: "18px auto", overflow: "hidden" }}>
            <div style={{ width: `${pct * 100}%`, height: "100%", background: `linear-gradient(90deg, ${actionColor[cs.action]}, ${C.amber})`, borderRadius: 4, transition: "width 1s linear" }} />
          </div>
          <p style={{ fontSize: 26, color: C.text, margin: "24px 0 8px", fontWeight: 600, lineHeight: 1.35 }}>{cs.text}</p>
          {cs.waterTo != null && <p style={{ fontSize: 34, color: C.teal, fontWeight: 800, margin: "14px 0" }}>Pour to {cs.waterTo}g <span style={{ fontSize: 20, color: C.subtle, fontWeight: 400 }}>(+{cs.waterAdd}g)</span></p>}
        </div>
        <div style={{ padding: "0 24px", marginTop: 10 }}>
          {recipe.steps.slice(brewStep + 1, brewStep + 3).map((s, i) => (
            <div key={i} style={{ display: "flex", gap: 8, marginBottom: 6, opacity: 0.45 }}>
              <span style={{ color: actionColor[s.action], fontSize: 16 }}>{actionIcon[s.action]}</span>
              <span style={{ fontSize: 14, color: C.subtle }}>{s.text} ({fmt(s.duration)})</span>
            </div>
          ))}
        </div>
        <div style={{ padding: "30px 20px", textAlign: "center" }}><button style={S.cancelBtn} onClick={cancelBrew}>Cancel Brew</button></div>
      </div>
    );
  }
  return null;
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
